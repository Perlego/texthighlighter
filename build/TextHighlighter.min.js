!function i(l,a,s){function f(t,e){if(!a[t]){if(!l[t]){var n="function"==typeof require&&require;if(!e&&n)return n(t,!0);if(u)return u(t,!0);var r=new Error("Cannot find module '"+t+"'");throw r.code="MODULE_NOT_FOUND",r}var o=a[t]={exports:{}};l[t][0].call(o.exports,function(e){return f(l[t][1][e]||e)},o,o.exports,i,l,a,s)}return a[t].exports}for(var u="function"==typeof require&&require,e=0;e<s.length;e++)f(s[e]);return f}({1:[function(r,e,t){(function(e){"use strict";var t,n=(t=r("./text-highlighter"))&&t.__esModule?t:{default:t};e.TextHighlighter=n.default}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./text-highlighter":2}],2:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.default=n.IGNORE_TAGS=n.END_OFFSET_ATTR=n.START_OFFSET_ATTR=n.TIMESTAMP_ATTR=n.DATA_ATTR=void 0;var p=function(e){{if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)if(Object.prototype.hasOwnProperty.call(e,n)){var r=Object.defineProperty&&Object.getOwnPropertyDescriptor?Object.getOwnPropertyDescriptor(e,n):{};r.get||r.set?Object.defineProperty(t,n,r):t[n]=e[n]}return t.default=e,t}}(e("./utils/dom")),r=e("./utils/events"),v=e("./utils/highlights"),o=e("./utils/arrays");function i(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),n.push.apply(n,r)}return n}function l(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?i(n,!0).forEach(function(e){a(t,e,n[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):i(n).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))})}return t}function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var c="data-highlighted";n.DATA_ATTR=c;var d="data-timestamp";n.TIMESTAMP_ATTR=d;var N="data-start-offset";n.START_OFFSET_ATTR=N;var T="data-end-offset";n.END_OFFSET_ATTR=T;var h=["SCRIPT","STYLE","SELECT","OPTION","BUTTON","OBJECT","APPLET","VIDEO","AUDIO","CANVAS","EMBED","PARAM","METER","PROGRESS"];n.IGNORE_TAGS=h;var f=function(){function n(e,t){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,n),!e)throw new Error("Missing anchor element");this.el=e,this.options=l({color:"#ffff7b",highlightedClass:"highlighted",contextClass:"highlighter-context",onRemoveHighlight:function(){return!0},onBeforeHighlight:function(){return!0},onAfterHighlight:function(){}},t),(0,p.default)(this.el).addClass(this.options.contextClass),(0,r.bindEvents)(this.el,this)}return function(e,t,n){t&&s(e.prototype,t),n&&s(e,n)}(n,[{key:"destroy",value:function(){(0,r.unbindEvents)(this.el,this),(0,p.default)(this.el).removeClass(this.options.contextClass)}},{key:"highlightHandler",value:function(){this.doHighlight()}},{key:"doHighlight",value:function(e){var t,n,r,o,i=(0,p.default)(this.el).getRange();i&&!i.collapsed&&(!0===this.options.onBeforeHighlight(i)&&(o=+new Date,(t=(0,v.createWrapper)(this.options)).setAttribute(d,o),n=this.highlightRangeCustom(i,t),r=this.normalizeHighlights(n),this.options.onAfterHighlight(i,r,o)),e||(0,p.default)(this.el).removeAllRanges())}},{key:"highlightRangeCustom",value:function(e,t){if(!e||e.collapsed)return[];console.log("ALSDebug29: RANGE: ",e);var n=[],r=t.cloneNode(!0),o=(0,v.getElementOffset)(e.startContainer,this.el)+e.startOffset,i=e.startContainer===e.endContainer?o+(e.endOffset-e.startOffset):(0,v.getElementOffset)(e.endContainer,this.el)+e.endOffset;console.log("ALSDebug29: startOffset: ",o,"endOffset: ",i),r.setAttribute(N,o),r.setAttribute(T,i),console.log("\n\n\n FINDING START CONTAINER FIRST TEXT NODE "),console.log("range.startContainer: ",e.startContainer);var l=(0,v.findTextNodeAtLocation)(e.startContainer,"start");console.log("\n\n\n FINDING END CONTAINER FIRST TEXT NODE "),console.log("range.endContainer: ",e.endContainer);var a=(0,v.findTextNodeAtLocation)(e.endContainer,"start");if(!l||!a)throw new Error("Failed to find the text node for the start or the end of the selected range");var s=e.endOffset<a.textContent.length-1?a.splitText(e.endOffset):a;if(l===a){var f=0<e.startOffset?l.splitText(e.startOffset):l;console.log("startContainer === endContainer!!!!!");var u=(0,p.default)(f).wrap(r);n.push(u)}else if(a.textContent.length>=e.endOffset){var d=l.splitText(e.startOffset),c=s.previousSibling;console.log("Node at the start of the new highlight: ",d),console.log("Node at the end of new highlight: ",c);var h=(0,v.findFirstNonSharedParent)({childElement:c,otherElement:d});if(h){var g=(0,v.extractElementContentForHighlight)({element:c,elementAncestor:h,options:this.options,locationInSelection:"end"});r.appendChild(d),g.classList.contains(this.options.highlightedClass)?g.childNodes.forEach(function(e){r.appendChild(e)}):r.appendChild(g),(0,p.default)(r).insertBefore(h),console.log("Node that is the wrapper of the end of the new highlight: ",h),console.log("Cloned of node that is the wrapper of the end of the new highlight after removing siblings and unwrapping highlight spans: ",g)}}return n}},{key:"highlightRange",value:function(e,t){if(!e||e.collapsed)return[];console.log("ALSDebug28: range before refined! ",e);for(var n,r,o,i=(0,v.refineRangeBoundaries)(e),l=i.startContainer,a=i.endContainer,s=i.goDeeper,f=!1,u=l,d=[];s&&u.nodeType===p.NODE_TYPE.TEXT_NODE&&(-1===h.indexOf(u.parentNode.tagName)&&""!==u.nodeValue.trim()&&((r=t.cloneNode(!0)).setAttribute(c,!0),o=u.parentNode,!(0,p.default)(this.el).contains(o)&&o!==this.el||(n=(0,p.default)(u).wrap(r),d.push(n))),s=!1),u!==a||a.hasChildNodes()&&s||(f=!0),u.tagName&&-1<h.indexOf(u.tagName)&&(a.parentNode===u&&(f=!0),s=!1),s&&u.hasChildNodes()?u=u.firstChild:s=u.nextSibling?(u=u.nextSibling,!0):(u=u.parentNode,!1),!f;);return d}},{key:"normalizeHighlights",value:function(e){var t;return e.forEach(function(e){(0,p.default)(e).normalizeTextNodes()}),t=e.filter(function(e){return e.parentElement?e:null}),(t=(0,o.unique)(t)).sort(function(e,t){return e.offsetTop-t.offsetTop||e.offsetLeft-t.offsetLeft}),t}},{key:"flattenNestedHighlights",value:function(f){var u=this;function e(){var s=!1;return f.forEach(function(e,t){var n=e.parentElement,r=n.previousSibling,o=n.nextSibling;if(u.isHighlight(n))if((0,v.haveSameColor)(n,e))n.replaceChild(e.firstChild,e),f[t]=n,s=!0;else{if(e.nextSibling||(o?(0,p.default)(e).insertBefore(o):(0,p.default)(e).insertAfter(n),s=!0),e.previousSibling||(r?(0,p.default)(e).insertAfter(r):(0,p.default)(e).insertBefore(n),s=!0),e.previousSibling&&3==e.previousSibling.nodeType&&e.nextSibling&&3==e.nextSibling.nodeType){var i=document.createElement("span");i.style.backgroundColor=n.style.backgroundColor,i.className=n.className;var l=n.attributes[d].nodeValue;i.setAttribute(d,l),i.setAttribute(c,!0);var a=i.cloneNode(!0);(0,p.default)(e.previousSibling).wrap(i),(0,p.default)(e.nextSibling).wrap(a),Array.prototype.slice.call(n.childNodes).forEach(function(e){(0,p.default)(e).insertBefore(e.parentNode)}),s=!0}n.hasChildNodes()||(0,p.default)(n).remove()}}),s}for((0,v.sortByDepth)(f,!0);e(););}},{key:"mergeSiblingHighlights",value:function(e){e.forEach(function(e){e.previousSibling,e.nextSibling;(0,p.default)(e).normalizeTextNodes()})}},{key:"setColor",value:function(e){this.options.color=e}},{key:"getColor",value:function(){return this.options.color}},{key:"removeHighlights",value:function(e){var t=e||this.el,n=this.getHighlights({container:t}),r=this;n.forEach(function(e){!0===r.options.onRemoveHighlight(e)&&function(e){e.className===t.className&&(0,p.default)(e).unwrap()}(e)})}},{key:"getHighlights",value:function(e){var t=(e=l({container:this.el,andSelf:!0,grouped:!1},e)).container.querySelectorAll("["+c+"]"),n=Array.prototype.slice.call(t);return!0===e.andSelf&&e.container.hasAttribute(c)&&n.push(e.container),e.grouped&&(n=(0,v.groupHighlights)(n,d)),n}},{key:"isHighlight",value:function(e){return e&&e.nodeType===p.NODE_TYPE.ELEMENT_NODE&&e.hasAttribute(c)}},{key:"serializeHighlights",value:function(){var e=this.getHighlights(),i=this.el,l=[];return(0,v.sortByDepth)(e,!1),e.forEach(function(e){var t=0,n=e.textContent.length,r=function(e,t){for(var n,r=[];n=Array.prototype.slice.call(e.parentNode.childNodes),r.unshift(n.indexOf(e)),(e=e.parentNode)!==t||!e;);return r}(e,i),o=e.cloneNode(!0);o.innerHTML="",o=o.outerHTML,e.previousSibling&&e.previousSibling.nodeType===p.NODE_TYPE.TEXT_NODE&&(t=e.previousSibling.length),l.push([o,e.textContent,r.join(":"),t,n])}),JSON.stringify(l)}},{key:"serializeHighlightsCustom",value:function(o){var e=this.getHighlights(),i=this.el,l=[];return(0,v.sortByDepth)(e,!1),e.forEach(function(e){var t=e.textContent.length,n=(0,v.getElementOffset)(e,i),r=e.cloneNode(!0);r.innerHTML="",r=r.outerHTML,console.log("Highlight text offset from root node: ",n),console.log("wrapper.toString().indexOf(".concat(o,"):"),r.toString().indexOf(o)),-1<r.toString().indexOf(o)&&l.push([r,e.textContent,n,t])}),JSON.stringify(l)}},{key:"deserializeHighlightsCustom",value:function(e){var t,s=[],f=this;if(!e)return s;try{t=JSON.parse(e)}catch(e){throw"Can't parse JSON: "+e}return t.forEach(function(e){try{console.log("Highlight: ",e),function(e){var t,n,r={wrapper:e[0],text:e[1],offset:Number.parseInt(e[2]),length:Number.parseInt(e[3])},o=f.el,i=(0,v.findNodeAndOffset)(r,o),l=i.node,a=i.offset;(t=l.splitText(a)).splitText(r.length),t.nextSibling&&!t.nextSibling.nodeValue&&(0,p.default)(t.nextSibling).remove(),t.previousSibling&&!t.previousSibling.nodeValue&&(0,p.default)(t.previousSibling).remove(),n=(0,p.default)(t).wrap((0,p.default)().fromHTML(r.wrapper)[0]),s.push(n)}(e)}catch(e){console&&console.warn&&console.warn("Can't deserialize highlight descriptor. Cause: "+e)}}),s}},{key:"deserializeHighlights",value:function(e){var t,a=[],s=this;if(!e)return a;try{t=JSON.parse(e)}catch(e){throw"Can't parse JSON: "+e}return t.forEach(function(e){try{!function(e){for(var t,n,r,o={wrapper:e[0],text:e[1],path:e[2].split(":"),offset:e[3],length:e[4]},i=o.path.pop(),l=s.el;r=o.path.shift();)l=l.childNodes[r];l.childNodes[i-1]&&l.childNodes[i-1].nodeType===p.NODE_TYPE.TEXT_NODE&&(i-=1),(t=(l=l.childNodes[i]).splitText(o.offset)).splitText(o.length),t.nextSibling&&!t.nextSibling.nodeValue&&(0,p.default)(t.nextSibling).remove(),t.previousSibling&&!t.previousSibling.nodeValue&&(0,p.default)(t.previousSibling).remove(),n=(0,p.default)(t).wrap((0,p.default)().fromHTML(o.wrapper)[0]),a.push(n)}(e)}catch(e){console&&console.warn&&console.warn("Can't deserialize highlight descriptor. Cause: "+e)}}),a}},{key:"find",value:function(e,t){var n=(0,p.default)(this.el).getWindow(),r=n.scrollX,o=n.scrollY,i=void 0===t||t;if((0,p.default)(this.el).removeAllRanges(),n.find)for(;n.find(e,i);)this.doHighlight(!0);else if(n.document.body.createTextRange){var l=n.document.body.createTextRange();for(l.moveToElementText(this.el);l.findText(e,1,i?4:0)&&((0,p.default)(this.el).contains(l.parentElement())||l.parentElement()===this.el);)l.select(),this.doHighlight(!0),l.collapse(!1)}(0,p.default)(this.el).removeAllRanges(),n.scrollTo(r,o)}}]),n}();n.default=f},{"./utils/arrays":3,"./utils/dom":4,"./utils/events":5,"./utils/highlights":6}],3:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.unique=function(e){return e.filter(function(e,t,n){return n.indexOf(e)===t})}},{}],4:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.default=n.NODE_TYPE=void 0;var r={ELEMENT_NODE:1,TEXT_NODE:3};n.NODE_TYPE=r;function i(o){return{addClass:function(e){o.classList?o.classList.add(e):o.className+=" "+e},removeClass:function(e){o.classList?o.classList.remove(e):o.className=o.className.replace(new RegExp("(^|\\b)"+e+"(\\b|$)","gi")," ")},prepend:function(e){for(var t=Array.prototype.slice.call(e),n=t.length;n--;)o.insertBefore(t[n],o.firstChild)},append:function(e){for(var t=Array.prototype.slice.call(e),n=0,r=t.length;n<r;++n)o.appendChild(t[n])},insertAfter:function(e){return e.parentNode.insertBefore(o,e.nextSibling)},insertBefore:function(e){return e.parentNode.insertBefore(o,e)},remove:function(){o.parentNode.removeChild(o),o=null},contains:function(e){return o!==e&&o.contains(e)},wrap:function(e){return o.parentNode&&o.parentNode.insertBefore(e,o),e.appendChild(o),e},unwrap:function(){var t,e=Array.prototype.slice.call(o.childNodes);return e.forEach(function(e){t=e.parentNode,i(e).insertBefore(e.parentNode)}),i(t).remove(),e},parents:function(){for(var e,t=[];e=o.parentNode;)t.push(e),o=e;return t},parentsWithoutDocument:function(){return this.parents().filter(function(e){return e!==document})},normalizeTextNodes:function(){if(o){if(o.nodeType===r.TEXT_NODE)for(;o.nextSibling&&o.nextSibling.nodeType===r.TEXT_NODE;)o.nodeValue+=o.nextSibling.nodeValue,o.parentNode.removeChild(o.nextSibling);else i(o.firstChild).normalizeTextNodes();i(o.nextSibling).normalizeTextNodes()}},color:function(){return o.style.backgroundColor},fromHTML:function(e){var t=document.createElement("div");return t.innerHTML=e,t.childNodes},getRange:function(){var e,t=i(o).getSelection();return 0<t.rangeCount&&(e=t.getRangeAt(0)),e},removeAllRanges:function(){i(o).getSelection().removeAllRanges()},getSelection:function(){return i(o).getWindow().getSelection()},getWindow:function(){return i(o).getDocument().defaultView},getDocument:function(){return o.ownerDocument||o}}}n.default=i},{}],5:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.bindEvents=function(e,t){e.addEventListener("mouseup",t.highlightHandler.bind(t)),e.addEventListener("touchend",t.highlightHandler.bind(t))},n.unbindEvents=function(e,t){e.removeEventListener("mouseup",t.highlightHandler.bind(t)),e.removeEventListener("touchend",t.highlightHandler.bind(t))}},{}],6:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.refineRangeBoundaries=function(e){var t=e.startContainer,n=e.endContainer,r=e.commonAncestorContainer,o=!0;if(0===e.endOffset){for(;!n.previousSibling&&n.parentNode!==r;)n=n.parentNode;n=n.previousSibling}else n.nodeType===f.NODE_TYPE.TEXT_NODE?e.endOffset<n.nodeValue.length&&n.splitText(e.endOffset):0<e.endOffset&&(n=n.childNodes.item(e.endOffset-1));t.nodeType===f.NODE_TYPE.TEXT_NODE?e.startOffset===t.nodeValue.length?o=!1:0<e.startOffset&&(t=t.splitText(e.startOffset),n===t.previousSibling&&(n=t)):t=e.startOffset<t.childNodes.length?t.childNodes.item(e.startOffset):t.nextSibling;return{startContainer:t,endContainer:n,goDeeper:o}},n.sortByDepth=function(e,n){e.sort(function(e,t){return(0,f.default)(n?t:e).parents().length-(0,f.default)(n?e:t).parents().length})},n.haveSameColor=function(e,t){return(0,f.default)(e).color()===(0,f.default)(t).color()},n.createWrapper=function(e){var t=document.createElement("span");return t.style.backgroundColor=e.color,t.className=e.highlightedClass,t},n.findTextNodeAtLocation=u,n.findNodeAndOffset=function(e,t){var n=t,r=0,o=0,i=!1;for(;n&&!i&&(r<e.offset||r===e.offset&&0<n.childNodes.length);){var l=r+n.textContent.length;l>e.offset?0===n.childNodes.length?(o=e.offset-r,i=!0,r+=o):n=n.childNodes[0]:(r=l,n=n.nextSibling)}return{node:n,offset:o}},n.getElementOffset=function(e,t){var n,r=0,o=e;do{var i=(n=Array.prototype.slice.call(o.parentNode.childNodes)).indexOf(o),l=a(n,i);r+=l,o=o.parentNode,1}while(o!==t||!o);return r},n.findFirstNonSharedParent=function(e){var t=e.childElement,n=e.otherElement,r=(0,f.default)(t).parentsWithoutDocument(),o=0,i=null;for(;!i&&o<r.length;){var l=r[o];l.contains(n)&&0<o&&(console.log("currentParent contains other element!",l),i=r[o-1]),o++}return i},n.extractElementContentForHighlight=function(e){var t=e.element,n=e.elementAncestor,r=e.options,o=e.locationInSelection,i=n.cloneNode(!0),l=u(i,"start"===o?"end":"start"),a=l.parentNode,s=l.nextSibling;for(;s;)a.removeChild(s),s=l.nextSibling;console.log("elementCopy: ",l),console.log("elementCopyParent: ",a),a!==i&&a.classList.contains(r.highlightedClass)&&(0,f.default)(a).unwrap();return t.parentNode.removeChild(t),i},n.groupHighlights=function(e,n){var r=[],o={},i=[];return e.forEach(function(e){var t=e.getAttribute(n);void 0===o[t]&&(o[t]=[],r.push(t)),o[t].push(e)}),r.forEach(function(e){var t=o[e];i.push({chunks:t,timestamp:e,toString:function(){return t.map(function(e){return e.textContent}).join("")}})}),i};var f=function(e){{if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)if(Object.prototype.hasOwnProperty.call(e,n)){var r=Object.defineProperty&&Object.getOwnPropertyDescriptor?Object.getOwnPropertyDescriptor(e,n):{};r.get||r.set?Object.defineProperty(t,n,r):t[n]=e[n]}return t.default=e,t}}(e("./dom"));function u(e,t){console.log("Element as parameter: ",e);for(var n=e,r=0;n&&n.nodeType!==f.NODE_TYPE.TEXT_NODE;){if(console.log("textNodeElement step ".concat(r),n),"start"===t)n=0<n.childNodes.length?n.childNodes[0]:n.nextSibling;else if("end"===t)if(0<n.childNodes.length){var o=n.childNodes.length-1;n=n.childNodes[o]}else n=n.previousSibling;else n=null;r++}return console.log("text node element returned: ",n),n}function a(e,t){for(var n=0,r=0;r<t;r++){var o=e[r].textContent;o&&0<o.length&&(n+=o.length)}return n}},{"./dom":4}]},{},[1]);